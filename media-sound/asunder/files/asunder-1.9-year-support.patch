From a08f6ee3a323bac77963afa2d64f60f0ed27e3d0 Mon Sep 17 00:00:00 2001
From: Sebastian Pipping <sebastian@pipping.org>
Date: Thu, 26 Nov 2009 18:47:12 +0100
Subject: [PATCH] Introduce year support in format strings (%Y)

---
 asunder-1.9/AUTHORS         |    4 ++++
 asunder-1.9/ChangeLog       |    4 ++++
 asunder-1.9/configure.in    |    2 +-
 asunder-1.9/src/interface.c |    2 +-
 asunder-1.9/src/threads.c   |   32 ++++++++++++++++++++++----------
 asunder-1.9/src/util.c      |   24 +++++++++++++++++++++++-
 asunder-1.9/src/util.h      |    3 ++-
 7 files changed, 57 insertions(+), 14 deletions(-)

diff --git a/asunder-1.9/AUTHORS b/asunder-1.9/AUTHORS
index 8ba9532..2258c75 100644
--- a/asunder-1.9/AUTHORS
+++ b/asunder-1.9/AUTHORS
@@ -17,6 +17,10 @@ Radu Potop
 http://wooptoo.com/
 - The new Asunder icon
 
+Sebastian Pipping
+http://www.hartwork.org/
+- %Y (year) in format strings
+
 Packages:
 
 Toni Graffy
diff --git a/asunder-1.9/ChangeLog b/asunder-1.9/ChangeLog
index d4f87f1..0fd018c 100644
--- a/asunder-1.9/ChangeLog
+++ b/asunder-1.9/ChangeLog
@@ -1,3 +1,7 @@
+26 November 2009 - 1.9.1
+========================
+- Support for year in format strings (%Y)
+
 1 Aug 2009 - 1.9
 ================
 - Added Arabic, Slovenian, Latvian, and Slovak translations.
diff --git a/asunder-1.9/configure.in b/asunder-1.9/configure.in
index 3afcfa9..87d8eca 100644
--- a/asunder-1.9/configure.in
+++ b/asunder-1.9/configure.in
@@ -1,7 +1,7 @@
 dnl Process this file with autoconf to produce a configure script.
 
 AC_INIT(configure.in)
-AM_INIT_AUTOMAKE(asunder, 1.9)
+AM_INIT_AUTOMAKE(asunder, 1.9.1)
 AM_CONFIG_HEADER(config.h)
 AM_MAINTAINER_MODE
 
diff --git a/asunder-1.9/src/interface.c b/asunder-1.9/src/interface.c
index 56cf34c..a36fdd2 100644
--- a/asunder-1.9/src/interface.c
+++ b/asunder-1.9/src/interface.c
@@ -406,7 +406,7 @@ create_prefs (void)
     gtk_widget_show (vbox);
     gtk_container_add (GTK_CONTAINER (frame2), vbox);
     
-    label = gtk_label_new (_("%A - Artist\n%L - Album\n%N - Track number (2-digit)\n%T - Song title"));
+    label = gtk_label_new (_("%A - Artist\n%L - Album\n%N - Track number (2-digit)\n%Y - Year (4-digit or \"0\")\n%T - Song title"));
     gtk_widget_show (label);
     gtk_box_pack_start (GTK_BOX (vbox), label, FALSE, FALSE, 0);
     gtk_misc_set_alignment (GTK_MISC (label), 0, 0);
diff --git a/asunder-1.9/src/threads.c b/asunder-1.9/src/threads.c
index 232ad44..c5b0282 100644
--- a/asunder-1.9/src/threads.c
+++ b/asunder-1.9/src/threads.c
@@ -137,11 +137,23 @@ void dorip()
     aac_percent = 0.0;
     rip_tracks_completed = 0;
     encode_tracks_completed = 0;
-    
+
+    // get year
+    GtkTreeIter iter;
+    GtkListStore * store = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW(lookup_widget(win_main, "tracklist"))));
+    gboolean rowsleft = gtk_tree_model_get_iter_first(GTK_TREE_MODEL(store), &iter);
+    unsigned year = 0;
+    if(rowsleft)
+    {
+        gtk_tree_model_get(GTK_TREE_MODEL(store), &iter,
+                           COL_YEAR, &year,
+                           -1);
+    }
+
     const char * albumartist = gtk_entry_get_text(GTK_ENTRY(lookup_widget(win_main, "album_artist")));
     const char * albumtitle = gtk_entry_get_text(GTK_ENTRY(lookup_widget(win_main, "album_title")));
-    char * albumdir = parse_format(global_prefs->format_albumdir, 0, albumartist, albumtitle, NULL);
-    char * playlist = parse_format(global_prefs->format_playlist, 0, albumartist, albumtitle, NULL);
+    char * albumdir = parse_format(global_prefs->format_albumdir, 0, year, albumartist, albumtitle, NULL);
+    char * playlist = parse_format(global_prefs->format_playlist, 0, year, albumartist, albumtitle, NULL);
     
     overwriteAll = false;
     overwriteNone = false;
@@ -166,9 +178,7 @@ void dorip()
     }
     
     // make sure there's some tracks to rip
-    GtkListStore * store = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW(lookup_widget(win_main, "tracklist"))));
-    GtkTreeIter iter;
-    gboolean rowsleft = gtk_tree_model_get_iter_first(GTK_TREE_MODEL(store), &iter);
+    rowsleft = gtk_tree_model_get_iter_first(GTK_TREE_MODEL(store), &iter);
     tracks_to_rip = 0;
     int riptrack;
     while(rowsleft)
@@ -343,12 +353,14 @@ gpointer rip(gpointer data)
     gdk_threads_leave();
     while(rowsleft)
     {
+        unsigned year = 0;
         gdk_threads_enter();
             gtk_tree_model_get(GTK_TREE_MODEL(store), &iter,
                 COL_RIPTRACK, &riptrack,
                 COL_TRACKNUM, &tracknum,
                 COL_TRACKARTIST, &trackartist,
                 COL_TRACKTITLE, &tracktitle,
+                COL_YEAR, &year,
                 -1);
         gdk_threads_leave();
         
@@ -359,8 +371,8 @@ gpointer rip(gpointer data)
         
         if (riptrack)
         {
-            albumdir = parse_format(global_prefs->format_albumdir, 0, albumartist, albumtitle, NULL);
-            musicfilename = parse_format(global_prefs->format_music, tracknum, trackartist, albumtitle, tracktitle);
+            albumdir = parse_format(global_prefs->format_albumdir, 0, year, albumartist, albumtitle, NULL);
+            musicfilename = parse_format(global_prefs->format_music, tracknum, year, trackartist, albumtitle, tracktitle);
             wavfilename = make_filename(prefs_get_music_dir(global_prefs), albumdir, musicfilename, "wav");
             
             debugLog("Ripping track %d to \"%s\"\n", tracknum, wavfilename);
@@ -507,8 +519,8 @@ gpointer encode(gpointer data)
         
         if (riptrack)
         {
-            albumdir = parse_format(global_prefs->format_albumdir, 0, album_artist, album_title, NULL);
-            musicfilename = parse_format(global_prefs->format_music, tracknum, trackartist, album_title, tracktitle);
+            albumdir = parse_format(global_prefs->format_albumdir, 0, year, album_artist, album_title, NULL);
+            musicfilename = parse_format(global_prefs->format_music, tracknum, year, trackartist, album_title, tracktitle);
             wavfilename = make_filename(prefs_get_music_dir(global_prefs), albumdir, musicfilename, "wav");
             mp3filename = make_filename(prefs_get_music_dir(global_prefs), albumdir, musicfilename, "mp3");
             oggfilename = make_filename(prefs_get_music_dir(global_prefs), albumdir, musicfilename, "ogg");
diff --git a/asunder-1.9/src/util.c b/asunder-1.9/src/util.c
index adfee3f..a75fe5d 100644
--- a/asunder-1.9/src/util.c
+++ b/asunder-1.9/src/util.c
@@ -522,12 +522,13 @@ void make_playlist(const char* filename, FILE** file)
 //
 // format - the format of the filename
 // tracknum - gets substituted for %N in format
+// year - gets substituted for %Y in format
 // artist - gets substituted for %A in format
 // album - gets substituted for %L in format
 // title - gets substituted for %T in format
 //
 // NOTE: caller must free the returned string!
-char * parse_format(const char * format, int tracknum, const char * artist, const char * album, const char * title)
+char * parse_format(const char * format, int tracknum, int year, const char * artist, const char * album, const char * title)
 {
     unsigned i = 0;
     int len = 0;
@@ -549,6 +550,12 @@ char * parse_format(const char * format, int tracknum, const char * artist, cons
                 case 'N':
                     if ((tracknum > 0) && (tracknum < 100)) len += 2;
                     break;
+                case 'Y':
+                    if ((year > 0) && (year < 10000))
+                        len += 4;
+                    else
+                        len += 1;
+                    break;
                 case 'T':
                     if (title) len += strlen(title);
                     break;
@@ -595,6 +602,21 @@ char * parse_format(const char * format, int tracknum, const char * artist, cons
                         pos += 2;
                     }
                     break;
+                case 'Y':
+                    if ((year > 0) && (year < 10000))
+                    {
+                        ret[pos] = '0'+(year/1000);
+                        ret[pos+1] = '0'+((year/100)%10);
+                        ret[pos+2] = '0'+((year/10)%10);
+                        ret[pos+3] = '0'+(year%10);
+                        pos += 4;
+                    }
+                    else
+                    {
+                        ret[pos] = '0';
+                        pos += 1;
+                    }
+                    break;
                 case 'T':
                     if (title)
                     {
diff --git a/asunder-1.9/src/util.h b/asunder-1.9/src/util.h
index 86315ae..9661cca 100644
--- a/asunder-1.9/src/util.h
+++ b/asunder-1.9/src/util.h
@@ -15,12 +15,13 @@ int int_to_musepack_int(int i);
 //
 // format - the format of the filename
 // tracknum - gets substituted for %N in format
+// year - gets substituted for %Y in format
 // artist - gets substituted for %A in format
 // album - gets substituted for %L in format
 // title - gets substituted for %T in format
 //
 // NOTE: caller must free the returned string!
-char * parse_format(const char * format, int tracknum, const char * artist, const char * album, const char * title);
+char * parse_format(const char * format, int tracknum, int year, const char * artist, const char * album, const char * title);
 
 // construct a filename from various parts
 //
-- 
1.6.5.3

